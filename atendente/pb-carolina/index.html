<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PegaSenha - Painel do Atendente - UBS Carolina Ramos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Só garantias básicas caso o style.css não tenha tudo */

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    .titulo {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0 0 4px;
    }

    .subtitulo {
      color: #666;
      font-size: 0.95rem;
      margin: 0 0 8px;
    }

    .erro {
      background: #ffe6e6;
      color: #b00020;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .botoes-acoes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primario { background: #2563eb; color: #fff; }
    .btn-sucesso { background: #16a34a; color: #fff; }
    .btn-perigo   { background: #dc2626; color: #fff; }
    .btn-aviso    { background: #eab308; color: #000; }
    .btn-neutro   { background: #0f766e; color: #fff; }

    .lista-fila {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 260px;
      overflow-y: auto;
      border-top: 1px solid #e5e7eb;
    }

    .item-fila {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.95rem;
    }

    .item-fila-atual {
      background: #dbeafe;
    }

    .tag-status {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 2px 8px;
    }

    .tag-aguardando { background: #e5f2ff; color: #1d4ed8; }
    .tag-atendida   { background: #dcfce7; color: #166534; }
    .tag-ausente    { background: #fee2e2; color: #b91c1c; }

    .stats {
      font-size: 0.85rem;
      color: #555;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="titulo">Fila atual</h1>
      <p class="subtitulo">UBS Carolina Ramos · Painel do atendente</p>
      <div id="erro" class="erro" style="display:none;">Falha de comunicação com o servidor.</div>

      <div class="botoes-acoes">
        <button class="btn-primario" id="btnChamarProximo">Chamar próximo</button>
        <button class="btn-sucesso" id="btnMarcarAtendida" disabled>Marcar como ATENDIDA</button>
        <button class="btn-perigo" id="btnMarcarAusente" disabled>Marcar como AUSENTE</button>
        <button class="btn-aviso" id="btnColocarEspera" disabled>Colocar em ESPERA</button>
        <button class="btn-neutro" id="btnRetomarEspera" disabled>Retomar da ESPERA</button>
      </div>

      <div id="infoAtual" class="subtitulo" style="margin-top:4px;">
        Nenhuma senha em atendimento.
      </div>

      <ul id="listaFila" class="lista-fila"></ul>

      <div id="stats" class="stats"></div>
    </div>
  </div>

  <script>
    const BASE_API = "https://pegasenha-api.vercel.app";
    const UBS_SLUG = "pb-carolina";

    let fila = [];
    let senhaAtualId = null;

    const elErro = document.getElementById("erro");
    const elLista = document.getElementById("listaFila");
    const elInfoAtual = document.getElementById("infoAtual");
    const elStats = document.getElementById("stats");

    const btnChamarProximo = document.getElementById("btnChamarProximo");
    const btnMarcarAtendida = document.getElementById("btnMarcarAtendida");
    const btnMarcarAusente = document.getElementById("btnMarcarAusente");
    const btnColocarEspera = document.getElementById("btnColocarEspera");
    const btnRetomarEspera = document.getElementById("btnRetomarEspera");

    function mostrarErro(msg) {
      elErro.textContent = msg || "Falha de comunicação com o servidor.";
      elErro.style.display = "block";
    }

    function esconderErro() {
      elErro.style.display = "none";
    }

    function atualizarBotoes() {
      const temAtual = !!senhaAtualId;
      btnMarcarAtendida.disabled = !temAtual;
      btnMarcarAusente.disabled = !temAtual;
      btnColocarEspera.disabled = !temAtual;
      btnRetomarEspera.disabled = !temAtual;
    }

    function renderFila() {
      elLista.innerHTML = "";

      fila.forEach(item => {
        const li = document.createElement("li");
        li.className = "item-fila";
        if (item.id === senhaAtualId) {
          li.className += " item-fila-atual";
        }

        const colEsq = document.createElement("div");
        colEsq.textContent = `${item.numero} · ${item.servico_nome}`;

        const colDir = document.createElement("div");
        const tag = document.createElement("span");
        tag.classList.add("tag-status");

        if (item.status === "aguardando") {
          tag.classList.add("tag-aguardando");
          tag.textContent = "Aguardando";
        } else if (item.status === "atendida") {
          tag.classList.add("tag-atendida");
          tag.textContent = "Atendida";
        } else if (item.status === "ausente") {
          tag.classList.add("tag-ausente");
          tag.textContent = "Ausente";
        } else {
          tag.textContent = item.status;
        }

        colDir.appendChild(tag);

        li.appendChild(colEsq);
        li.appendChild(colDir);

        li.addEventListener("click", () => {
          senhaAtualId = item.id;
          atualizarInfoAtual();
          atualizarBotoes();
          renderFila();
        });

        elLista.appendChild(li);
      });

      atualizarStats();
    }

    function atualizarInfoAtual() {
      const atual = fila.find(f => f.id === senhaAtualId);

      if (!atual) {
        elInfoAtual.textContent = "Nenhuma senha em atendimento.";
        return;
      }

      elInfoAtual.textContent =
        `Atendendo: ${atual.numero} · ${atual.servico_nome}`;
    }

    function atualizarStats() {
      const total = fila.length;
      const aguardando = fila.filter(f => f.status === "aguardando").length;
      const atendidas = fila.filter(f => f.status === "atendida").length;
      const ausentes = fila.filter(f => f.status === "ausente").length;

      elStats.textContent =
        `Total: ${total} · Aguardando: ${aguardando} · Atendidas: ${atendidas} · Ausentes: ${ausentes}`;
    }

    async function carregarFila() {
      try {
        esconderErro();

        const resp = await fetch(`${BASE_API}/api/fila/${UBS_SLUG}`);
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json();
        if (!data.ok) {
          throw new Error("Resposta inválida da API");
        }

        fila = data.fila || [];
        senhaAtualId = null;
        atualizarInfoAtual();
        atualizarBotoes();
        renderFila();
      } catch (err) {
        console.error(err);
        mostrarErro("Falha de comunicação com o servidor.");
      }
    }

    // Ações locais (por enquanto só no front, sem salvar na API)
    btnChamarProximo.addEventListener("click", () => {
      const proximo = fila.find(f => f.status === "aguardando");
      if (!proximo) {
        alert("Não há senhas aguardando.");
        return;
      }
      senhaAtualId = proximo.id;
      atualizarInfoAtual();
      atualizarBotoes();
      renderFila();
    });

    btnMarcarAtendida.addEventListener("click", () => {
      if (!senhaAtualId) return;
      fila = fila.map(f =>
        f.id === senhaAtualId ? { ...f, status: "atendida" } : f
      );
      atualizarInfoAtual();
      atualizarBotoes();
      renderFila();
    });

    btnMarcarAusente.addEventListener("click", () => {
      if (!senhaAtualId) return;
      fila = fila.map(f =>
        f.id === senhaAtualId ? { ...f, status: "ausente" } : f
      );
      atualizarInfoAtual();
      atualizarBotoes();
      renderFila();
    });

    btnColocarEspera.addEventListener("click", () => {
      if (!senhaAtualId) return;
      fila = fila.map(f =>
        f.id === senhaAtualId ? { ...f, status: "aguardando" } : f
      );
      atualizarInfoAtual();
      atualizarBotoes();
      renderFila();
    });

    btnRetomarEspera.addEventListener("click", () => {
      // Mesmo comportamento do Colocar em ESPERA, por enquanto
      if (!senhaAtualId) return;
      fila = fila.map(f =>
        f.id === senhaAtualId ? { ...f, status: "aguardando" } : f
      );
      atualizarInfoAtual();
      atualizarBotoes();
      renderFila();
    });

    // Carrega a fila ao abrir a página
    carregarFila();
  </script>
</body>
</html>
