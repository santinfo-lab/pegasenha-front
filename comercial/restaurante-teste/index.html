<!--
  PegaSenha Front – Host Restaurante de Teste
  Arquivo: /host/restaurante-teste/index.html

  Versão atual: v0.2.2
  Histórico de versões:
  - v0.2.0 – 18/11/2025 – Tela de Host para restaurantes, com fila de mesas,
    registro de mesas livres e visualização básica.
  - v0.2.1 – 19/11/2025 – Removido auto-refresh automático (setInterval).
  - v0.2.2 – 19/11/2025 – Simplificação do JavaScript, uso de DOMContentLoaded
    e tratamento seguro de eventos para evitar travar o carregamento.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PegaSenha – Host Restaurante de Teste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="card card-wide">
    <div class="topbar">
      <div>
        <h1 class="top-title">
          Host – <span class="brand-accent">Restaurante de Teste</span>
        </h1>
        <p class="subtitle" style="margin-top:4px;">
          Controle de fila de mesas e registro de mesas livres via PegaSenha.
        </p>
      </div>
      <div class="top-actions">
        <div class="pill">
          Unidade: <strong style="margin-left:4px;">restaurante-teste</strong>
        </div>
        <div class="pill small">
          Atualizado às <span id="ultima-atualizacao">–</span>
        </div>
        <button id="btn-recarregar" class="btn-secondary small">
          Atualizar agora
        </button>
      </div>
    </div>

    <section class="layout">
      <!-- Coluna principal -->
      <div class="layout-main">
        <!-- Resumo da fila -->
        <section style="margin-bottom:16px;">
          <h2>Resumo da fila</h2>
          <ul class="stats-list" id="stats-resumo">
            <li>Carregando...</li>
          </ul>
        </section>

        <!-- Tabela da fila -->
        <section>
          <h2>Fila de senhas</h2>
          <div id="erro-fila" class="erro" style="display:none; margin-bottom:8px;"></div>

          <div class="fila-table-wrapper">
            <table class="fila-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Senha</th>
                  <th>Pessoas</th>
                  <th>Tipo</th>
                  <th>Status</th>
                  <th>Criado em</th>
                </tr>
              </thead>
              <tbody id="tbody-fila">
                <tr>
                  <td colspan="6">Carregando fila...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <p class="small" style="margin-top:8px; color:#6b7280;">
            As senhas exibidas são apenas do tipo <strong>mesa</strong> para a unidade
            <code>restaurante-teste</code>.
          </p>
        </section>
      </div>

      <!-- Coluna lateral: mesas livres + últimas chamadas (visual) -->
      <aside class="layout-side">
        <!-- Registro de mesas livres -->
        <section class="solidaria">
          <h3>Mesas livres registradas</h3>
          <p class="small" style="color:#6b7280;">
            Quando uma mesa ficar livre, informe a quantidade de lugares e, se quiser,
            uma observação (ex.: "mesa 7, perto da janela").
          </p>

          <form id="form-mesa-livre" class="form">
            <div class="field">
              <label for="lugares">Lugares</label>
              <input
                id="lugares"
                name="lugares"
                type="number"
                min="1"
                max="20"
                placeholder="Ex.: 2, 4, 6"
                required
              />
            </div>
            <div class="field">
              <label for="obs">Observação (opcional)</label>
              <input
                id="obs"
                name="obs"
                type="text"
                maxlength="80"
                placeholder='Ex.: "mesa 7, perto da janela"'
              />
            </div>
            <div class="actions">
              <button type="submit" class="btn">
                Registrar mesa livre
              </button>
            </div>
          </form>

          <div id="lista-mesas-livres" class="small">
            Nenhuma mesa livre registrada.
          </div>
        </section>

        <hr class="divider" />

        <!-- Últimas chamadas (por enquanto apenas exibidas) -->
        <section>
          <h3>Últimas chamadas</h3>
          <ul id="lista-chamadas" class="calls-list">
            <li class="small">Nenhuma chamada registrada ainda.</li>
          </ul>
        </section>
      </aside>
    </section>
  </main>

  <script>
    (function () {
      var API_BASE = "https://pegasenha-api.vercel.app/api";
      var UBS_SLUG = "restaurante-teste";

      var statsEl = document.getElementById("stats-resumo");
      var tbodyFila = document.getElementById("tbody-fila");
      var erroFilaEl = document.getElementById("erro-fila");
      var ultimaAtualizacaoEl = document.getElementById("ultima-atualizacao");
      var btnRecarregar = document.getElementById("btn-recarregar");
      var formMesaLivre = document.getElementById("form-mesa-livre");
      var listaMesasLivresEl = document.getElementById("lista-mesas-livres");
      var listaChamadasEl = document.getElementById("lista-chamadas");

      var estadoFront = {
        mesasLivres: []
      };

      function formatHora(iso) {
        if (!iso) return "-";
        var d = new Date(iso);
        return d.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      function carregarFila() {
        erroFilaEl.style.display = "none";
        erroFilaEl.textContent = "";

        fetch(API_BASE + "/fila/" + UBS_SLUG)
          .then(function (resp) {
            if (!resp.ok) {
              throw new Error("Falha ao consultar a API: " + resp.status);
            }
            return resp.json();
          })
          .then(function (data) {
            var fila = Array.isArray(data.fila) ? data.fila : [];
            var stats = data.stats || {
              total: 0,
              aguardando: 0,
              atendidas: 0,
              ausentes: 0
            };
            var ultCham = Array.isArray(data.ultimas_chamadas)
              ? data.ultimas_chamadas
              : [];

            // Stats
            statsEl.innerHTML = "";
            var li1 = document.createElement("li");
            li1.innerHTML = "<span>Total:</span> <strong>" + stats.total + "</strong>";
            var li2 = document.createElement("li");
            li2.innerHTML = "<span>Aguardando:</span> <strong>" + stats.aguardando + "</strong>";
            var li3 = document.createElement("li");
            li3.innerHTML = "<span>Atendidas:</span> <strong>" + stats.atendidas + "</strong>";
            var li4 = document.createElement("li");
            li4.innerHTML = "<span>Ausentes:</span> <strong>" + stats.ausentes + "</strong>";
            statsEl.appendChild(li1);
            statsEl.appendChild(li2);
            statsEl.appendChild(li3);
            statsEl.appendChild(li4);

            // Tabela
            tbodyFila.innerHTML = "";
            if (!fila.length) {
              var tr = document.createElement("tr");
              var td = document.createElement("td");
              td.colSpan = 6;
              td.textContent = "Nenhuma senha na fila no momento.";
              tr.appendChild(td);
              tbodyFila.appendChild(tr);
            } else {
              fila.forEach(function (item, idx) {
                var tr = document.createElement("tr");

                var tdIdx = document.createElement("td");
                tdIdx.textContent = String(idx + 1);

                var tdNum = document.createElement("td");
                tdNum.innerHTML = "<strong>" + (item.numero || "-") + "</strong>";

                var tdPessoas = document.createElement("td");
                tdPessoas.textContent =
                  item.qtd_pessoas != null ? String(item.qtd_pessoas) : "-";

                var tdTipo = document.createElement("td");
                var spanTipo = document.createElement("span");
                spanTipo.className = "badge";
                spanTipo.textContent = item.tipo_senha || "mesa";
                tdTipo.appendChild(spanTipo);

                var tdStatus = document.createElement("td");
                tdStatus.textContent = item.status || "aguardando";

                var tdCriado = document.createElement("td");
                tdCriado.textContent = formatHora(item.criado_em);

                tr.appendChild(tdIdx);
                tr.appendChild(tdNum);
                tr.appendChild(tdPessoas);
                tr.appendChild(tdTipo);
                tr.appendChild(tdStatus);
                tr.appendChild(tdCriado);

                tbodyFila.appendChild(tr);
              });
            }

            // Últimas chamadas (apenas exibe)
            listaChamadasEl.innerHTML = "";
            if (!ultCham.length) {
              var li = document.createElement("li");
              li.className = "small";
              li.textContent = "Nenhuma chamada registrada ainda.";
              listaChamadasEl.appendChild(li);
            } else {
              ultCham.forEach(function (c) {
                var li = document.createElement("li");
                li.className = "small";
                li.textContent =
                  formatHora(c.chamado_em) +
                  " – Senha " +
                  (c.numero || "?") +
                  (c.mesa_atribuida ? " (mesa " + c.mesa_atribuida + ")" : "");
                listaChamadasEl.appendChild(li);
              });
            }

            // Atualiza relógio
            var agora = new Date();
            ultimaAtualizacaoEl.textContent = agora.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          })
          .catch(function (err) {
            console.error(err);
            erroFilaEl.textContent =
              "Erro ao consultar a API da fila. Tente novamente em alguns instantes.";
            erroFilaEl.style.display = "block";
          });
      }

      function renderizarMesasLivres() {
        var lista = estadoFront.mesasLivres;
        if (!lista.length) {
          listaMesasLivresEl.textContent = "Nenhuma mesa livre registrada.";
          return;
        }

        var ul = document.createElement("ul");
        ul.className = "calls-list";

        lista.forEach(function (m) {
          var li = document.createElement("li");
          li.className = "small";
          li.textContent =
            (m.lugares || "?") +
            " lugares – " +
            (m.obs || "sem observação") +
            " (" +
            formatHora(m.criado_em) +
            ")";
          ul.appendChild(li);
        });

        listaMesasLivresEl.innerHTML = "";
        listaMesasLivresEl.appendChild(ul);
      }

      function registrarMesaLivreLocal(lugares, obs) {
        estadoFront.mesasLivres.push({
          id: Date.now(),
          lugares: lugares,
          obs: obs || "",
          criado_em: new Date().toISOString()
        });
        renderizarMesasLivres();
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Carrega fila ao abrir
        carregarFila();

        // Botão de atualizar
        if (btnRecarregar) {
          btnRecarregar.addEventListener("click", function () {
            carregarFila();
          });
        }

        // Formulário de mesa livre (somente front, sem API ainda)
        if (formMesaLivre) {
          formMesaLivre.addEventListener("submit", function (ev) {
            ev.preventDefault();
            var inputLugares = document.getElementById("lugares");
            var inputObs = document.getElementById("obs");
            var n = parseInt(inputLugares.value, 10);

            if (!n || n <= 0) {
              alert("Informe a quantidade de lugares.");
              return;
            }

            registrarMesaLivreLocal(n, (inputObs.value || "").trim());
            formMesaLivre.reset();
            inputLugares.focus();
          });
        }
      });
    })();
  </script>
</body>
</html>
