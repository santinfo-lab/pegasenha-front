<!--
  PegaSenha Front – Host Restaurante de Teste
  Arquivo: /host/restaurante-teste/index.html

  Versão atual: v0.2.1
  Histórico de versões:
  - v0.2.0 – 18/11/2025 – Tela de Host para restaurantes, com fila de mesas,
    registro de mesas livres e atribuição básica.
  - v0.2.1 – 19/11/2025 – Removido auto-refresh automático (setInterval) para
    evitar perder a seleção de senha ou mesa durante a atribuição.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PegaSenha – Host Restaurante de Teste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="card card-wide">
    <div class="topbar">
      <div>
        <h1 class="top-title">
          Host – <span class="brand-accent">Restaurante de Teste</span>
        </h1>
        <p class="subtitle" style="margin-top:4px;">
          Controle de fila de mesas e registro de mesas livres via PegaSenha.
        </p>
      </div>
      <div class="top-actions">
        <div class="pill">
          Unidade: <strong style="margin-left:4px;">restaurante-teste</strong>
        </div>
        <div class="pill small">
          Atualizado às <span id="ultima-atualizacao">–</span>
        </div>
        <button id="btn-recarregar" class="btn-secondary small">
          Atualizar agora
        </button>
      </div>
    </div>

    <section class="layout">
      <!-- Coluna principal -->
      <div class="layout-main">
        <!-- Resumo da fila -->
        <section style="margin-bottom:16px;">
          <h2>Resumo da fila</h2>
          <ul class="stats-list" id="stats-resumo">
            <li>Carregando...</li>
          </ul>
        </section>

        <!-- Tabela da fila -->
        <section>
          <h2>Fila de senhas</h2>
          <div id="erro-fila" class="erro" style="display:none; margin-bottom:8px;"></div>

          <div class="fila-table-wrapper">
            <table class="fila-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Senha</th>
                  <th>Pessoas</th>
                  <th>Tipo</th>
                  <th>Status</th>
                  <th>Criado em</th>
                </tr>
              </thead>
              <tbody id="tbody-fila">
                <tr>
                  <td colspan="6">Carregando fila...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <p class="small" style="margin-top:8px; color:#6b7280;">
            As senhas exibidas são apenas do tipo <strong>mesa</strong> para a unidade
            <code>restaurante-teste</code>.
          </p>
        </section>
      </div>

      <!-- Coluna lateral: mesas livres + últimas chamadas -->
      <aside class="layout-side">
        <!-- Registro de mesas livres -->
        <section class="solidaria">
          <h3>Mesas livres registradas</h3>
          <p class="small" style="color:#6b7280;">
            Quando uma mesa ficar livre, informe a quantidade de lugares e, se quiser,
            uma observação (ex.: "mesa 7, perto da janela").
          </p>

          <form id="form-mesa-livre" class="form">
            <div class="field">
              <label for="lugares">Lugares</label>
              <input
                id="lugares"
                name="lugares"
                type="number"
                min="1"
                max="20"
                placeholder="Ex.: 2, 4, 6"
                required
              />
            </div>
            <div class="field">
              <label for="obs">Observação (opcional)</label>
              <input
                id="obs"
                name="obs"
                type="text"
                maxlength="80"
                placeholder='Ex.: "mesa 7, perto da janela"'
              />
            </div>
            <div class="actions">
              <button type="submit" class="btn">
                Registrar mesa livre
              </button>
            </div>
          </form>

          <div id="lista-mesas-livres" class="small">
            Nenhuma mesa livre registrada.
          </div>
        </section>

        <hr class="divider" />

        <!-- Últimas chamadas -->
        <section>
          <h3>Últimas chamadas</h3>
          <ul id="lista-chamadas" class="calls-list">
            <li class="small">Nenhuma chamada registrada ainda.</li>
          </ul>
        </section>
      </aside>
    </section>
  </main>

  <script>
    // ------------------ CONFIGURAÇÃO BÁSICA ------------------
    const API_BASE = "https://pegasenha-api.vercel.app/api";
    const UBS_SLUG = "restaurante-teste";

    // IDs e referências
    const statsEl = document.getElementById("stats-resumo");
    const tbodyFila = document.getElementById("tbody-fila");
    const erroFilaEl = document.getElementById("erro-fila");
    const ultimaAtualizacaoEl = document.getElementById("ultima-atualizacao");
    const btnRecarregar = document.getElementById("btn-recarregar");
    const formMesaLivre = document.getElementById("form-mesa-livre");
    const listaMesasLivresEl = document.getElementById("lista-mesas-livres");
    const listaChamadasEl = document.getElementById("lista-chamadas");

    // Estado em memória no front para seleção de senha/mesa
    let estadoFront = {
      fila: [],
      mesasLivres: [],
      ultimasChamadas: [],
    };

    // Utilitário para formatar hora
    function formatHora(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      return d.toLocaleTimeString("pt-BR", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // ------------------ CARREGAMENTO DA FILA ------------------
    async function carregarFila() {
      erroFilaEl.style.display = "none";
      erroFilaEl.textContent = "";

      try {
        const resp = await fetch(\`\${API_BASE}/fila/\${UBS_SLUG}\`);
        if (!resp.ok) {
          throw new Error("Falha ao consultar a API da fila: " + resp.status);
        }

        const data = await resp.json();
        const fila = Array.isArray(data.fila) ? data.fila : [];
        const stats = data.stats || {
          total: 0,
          aguardando: 0,
          atendidas: 0,
          ausentes: 0,
        };
        const ultCham = Array.isArray(data.ultimas_chamadas)
          ? data.ultimas_chamadas
          : [];

        // Atualiza estado local
        estadoFront.fila = fila;
        estadoFront.ultimasChamadas = ultCham;

        // Atualiza stats
        statsEl.innerHTML = "";
        const liTotal = document.createElement("li");
        liTotal.innerHTML =
          "<span>Total:</span> <strong>" + stats.total + "</strong>";
        const liAguard = document.createElement("li");
        liAguard.innerHTML =
          "<span>Aguardando:</span> <strong>" + stats.aguardando + "</strong>";
        const liAtend = document.createElement("li");
        liAtend.innerHTML =
          "<span>Atendidas:</span> <strong>" + stats.atendidas + "</strong>";
        const liAus = document.createElement("li");
        liAus.innerHTML =
          "<span>Ausentes:</span> <strong>" + stats.ausentes + "</strong>";

        statsEl.appendChild(liTotal);
        statsEl.appendChild(liAguard);
        statsEl.appendChild(liAtend);
        statsEl.appendChild(liAus);

        // Monta tabela da fila (somente tipo 'mesa' por enquanto)
        tbodyFila.innerHTML = "";
        if (!fila.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "Nenhuma senha na fila no momento.";
          tr.appendChild(td);
          tbodyFila.appendChild(tr);
        } else {
          fila.forEach((item, idx) => {
            const tr = document.createElement("tr");

            const tdIdx = document.createElement("td");
            tdIdx.textContent = String(idx + 1);

            const tdNumero = document.createElement("td");
            tdNumero.innerHTML = "<strong>" + (item.numero || "-") + "</strong>";

            const tdPessoas = document.createElement("td");
            tdPessoas.textContent =
              item.qtd_pessoas != null ? String(item.qtd_pessoas) : "-";

            const tdTipo = document.createElement("td");
            tdTipo.innerHTML =
              '<span class="badge">' + (item.tipo_senha || "mesa") + "</span>";

            const tdStatus = document.createElement("td");
            tdStatus.textContent = item.status || "aguardando";

            const tdCriado = document.createElement("td");
            tdCriado.textContent = formatHora(item.criado_em);

            tr.appendChild(tdIdx);
            tr.appendChild(tdNumero);
            tr.appendChild(tdPessoas);
            tr.appendChild(tdTipo);
            tr.appendChild(tdStatus);
            tr.appendChild(tdCriado);

            tbodyFila.appendChild(tr);
          });
        }

        // Atualiza últimas chamadas (apenas visual, sem ações ainda)
        listaChamadasEl.innerHTML = "";
        if (!ultCham.length) {
          const li = document.createElement("li");
          li.className = "small";
          li.textContent = "Nenhuma chamada registrada ainda.";
          listaChamadasEl.appendChild(li);
        } else {
          ultCham.forEach((c) => {
            const li = document.createElement("li");
            li.className = "small";
            li.textContent =
              formatHora(c.chamado_em) +
              " – Senha " +
              (c.numero || "?") +
              (c.mesa_atribuida ? " (mesa " + c.mesa_atribuida + ")" : "");
            listaChamadasEl.appendChild(li);
          });
        }

        // Atualiza texto de "última atualização"
        const agora = new Date();
        ultimaAtualizacaoEl.textContent = agora.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      } catch (erro) {
        console.error(erro);
        erroFilaEl.textContent =
          "Erro ao consultar a API da fila. Tente novamente em alguns instantes.";
        erroFilaEl.style.display = "block";
      }
    }

    // ------------------ MESAS LIVRES ------------------
    // OBS: Aqui estou considerando que ainda não temos endpoint
    // dedicado para mesas livres. Por enquanto, mantemos somente
    // no front-end para testes visuais.
    function registrarMesaLivreLocal(lugares, obs) {
      estadoFront.mesasLivres.push({
        id: Date.now(),
        lugares,
        obs: obs || "",
        criado_em: new Date().toISOString(),
      });
      renderizarMesasLivres();
    }

    function renderizarMesasLivres() {
      const lista = estadoFront.mesasLivres;
      if (!lista.length) {
        listaMesasLivresEl.textContent = "Nenhuma mesa livre registrada.";
        return;
      }

      const ul = document.createElement("ul");
      ul.className = "calls-list";

      lista.forEach((m) => {
        const li = document.createElement("li");
        li.className = "small";
        li.textContent =
          (m.lugares || "?") +
          " lugares – " +
          (m.obs || "sem observação") +
          " (" +
          formatHora(m.criado_em) +
          ")";
        ul.appendChild(li);
      });

      listaMesasLivresEl.innerHTML = "";
      listaMesasLivresEl.appendChild(ul);
    }

    formMesaLivre.addEventListener("submit", (ev) => {
      ev.preventDefault();
      const lugares = parseInt(formMesaLivre.lugares.value, 10);
      const obs = formMesaLivre.obs.value.trim();

      if (!lugares || lugares <= 0) {
        alert("Informe a quantidade de lugares.");
        return;
      }

      registrarMesaLivreLocal(lugares, obs);
      formMesaLivre.reset();
      formMesaLivre.lugares.focus();
    });

    // ------------------ INICIALIZAÇÃO ------------------
    btnRecarregar.addEventListener("click", () => {
      carregarFila();
    });

    // Carrega dados ao abrir
    carregarFila();

    // IMPORTANTE:
    // Auto-refresh desativado para não atrapalhar a interação
    // (antes havia: setInterval(carregarFila, 5000); )
  </script>
</body>
</html>
